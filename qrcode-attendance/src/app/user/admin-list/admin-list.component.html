<div class="mb-4">
  <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-4">
    <div class="flex flex-wrap items-center gap-2">
      <input nz-input placeholder="Nhập để tìm kiếm" [(ngModel)]="search" (keyup.enter)="onSearch()"
        class="border rounded px-2 py-1 w-64" />

      <button nz-button nzType="primary" (click)="onSearch()"
        class="border rounded px-3 py-1 font-semibold text-[15px] flex items-center">
        <i nz-icon nzType="search" class="mr-1 text-[16px] font-bold"></i>
        <span>Tìm kiếm</span>
      </button>

      <button nz-button (click)="refreshList()" class="flex items-center border rounded px-3 py-1 font-semibold">
        <i nz-icon nzType="reload" class="mr-1"></i>
        <span>Làm mới</span>
      </button>

      <a nz-dropdown [nzDropdownMenu]="advMenu" nzTrigger="click">
        <button nz-button>
          <i nz-icon nzType="filter"></i>
          <span class="ml-1 font-semibold">Tìm nâng cao</span>
          <i nz-icon nzType="down" class="ml-1"></i>
        </button>
      </a>

      <nz-dropdown-menu #advMenu="nzDropdownMenu">
        <div nz-menu class="p-3" style="min-width: 320px;">
          <div class="text-sm font-semibold mb-2">Bộ lọc nâng cao</div>
          <div class="grid grid-cols-1 gap-2">
            <div class="flex flex-col">
              <label class="mb-1 font-medium">Quyền</label>
              <nz-select [(ngModel)]="filterMaQuyen" style="width:100%" nzAllowClear nzPlaceHolder="Chọn quyền">
                <nz-option *ngFor="let r of roles" [nzLabel]="(r.tenQuyen || r.label || r.ten)"
                  [nzValue]="r.maQuyen || r.value || r"></nz-option>
              </nz-select>
            </div>

            <div class="flex flex-col">
              <label class="mb-1 font-medium">Trạng thái</label>
              <nz-select [(ngModel)]="filterTrangThaiUser" style="width:100%">
                <nz-option nzLabel="Tất cả" [nzValue]="undefined"></nz-option>
                <nz-option nzLabel="Hoạt động" [nzValue]="true"></nz-option>
                <nz-option nzLabel="Ngừng hoạt động" [nzValue]="false"></nz-option>
              </nz-select>
            </div>

            <div class="flex justify-end gap-2 mt-1">
              <button nz-button (click)="clearAdvanced()" class="border rounded px-2 py-1">Làm mới</button>
              <button nz-button nzType="primary" (click)="onSearch()" class="border rounded px-3 py-1">Tìm kiếm</button>
            </div>
          </div>
        </div>
      </nz-dropdown-menu>

    </div>
    <div class="mt-2 sm:mt-0">
      <button nz-button nzType="primary" (click)="openCreate()"
        class="border rounded px-3 py-1 font-semibold text-[15px] flex items-center">
        <i nz-icon nzType="plus" class="mr-1 text-[16px] font-bold"></i>
        <span>Thêm</span>
      </button>
    </div>
  </div>
  <div class="mb-3">
    <div class="flex gap-2 mb-2">
      <button *ngIf="setOfCheckedId.size > 0" nz-button nzType="default" nzDanger (click)="deleteSelected()"
        style="border-radius: 6px; border: 1px solid #ff4d4f;">
        <span nz-icon nzType="stop" nzTheme="outline"></span>
        <span class="ml-2">Vô hiệu hóa các mục đã chọn</span>
        <span class="ml-2 text-orange-600 font-semibold">({{ setOfCheckedId.size }})</span>
      </button>
    </div>
  </div>

  <app-scroll [height]="'60vh'">
    <nz-table #basicTable [nzData]="users" [nzBordered]="true" [nzLoading]="loading" [nzFrontPagination]="false"
      (nzCurrentPageDataChange)="onCurrentPageDataChange($event)" [nzPageSize]="pageSize" [nzPageIndex]="page"
      (nzPageIndexChange)="onPageChange($event)" [nzNoResult]="emptyTpl">
      <thead>
        <tr>
          <th [nzChecked]="checked" [nzIndeterminate]="indeterminate" (nzCheckedChange)="onAllChecked($event)"
            nzWidth="60px"></th>
          <th style="width:56px; text-align:center">Thao tác</th>
          <th style="width:56px; text-align:center; font-weight:bold">STT</th>
          <th style="font-weight: bold; text-align: center; cursor: pointer;" (click)="changeSort('tenDangNhap')">
            Tên đăng nhập
            <i nz-icon
              [nzType]="sortBy === 'tenDangNhap' ? (sortDir === 'asc' ? 'caret-up' : 'caret-down') : 'caret-up'"
              [ngClass]="{'text-blue-600': sortBy === 'tenDangNhap'}" class="ml-1"></i>
          </th>
          <th style="font-weight: bold; text-align: center; cursor: pointer;" (click)="changeSort('hoTen')">
            Họ tên
            <i nz-icon [nzType]="sortBy === 'hoTen' ? (sortDir === 'asc' ? 'caret-up' : 'caret-down') : 'caret-up'"
              [ngClass]="{'text-blue-600': sortBy === 'hoTen'}" class="ml-1"></i>
          </th>
          <th style="font-weight: bold; text-align: center; cursor: pointer;" (click)="changeSort('tenQuyen')">
            Quyền
            <i nz-icon [nzType]="sortBy === 'tenQuyen' ? (sortDir === 'asc' ? 'caret-up' : 'caret-down') : 'caret-up'"
              [ngClass]="{'text-blue-600': sortBy === 'tenQuyen'}" class="ml-1"></i>
          </th>
          <th style="font-weight: bold; text-align: center;">Trạng thái</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let u of basicTable.data; index as i">
          <td [nzChecked]="setOfCheckedId.has(u.tenDangNhap || u.TenDangNhap || u.maNguoiDung || u.MaNguoiDung)"
            (nzCheckedChange)="onItemChecked(u.tenDangNhap || u.TenDangNhap || u.maNguoiDung || u.MaNguoiDung, $event)">
          </td>
          <td class="text-center">
            <a nz-dropdown [nzDropdownMenu]="menu" nzTrigger="hover">
              <span nz-icon nzType="bars" nzTheme="outline"></span>
            </a>
            <nz-dropdown-menu #menu="nzDropdownMenu">
              <ul nz-menu nzSelectable>
                <li nz-menu-item (click)="openEdit(u)">
                  <span nz-icon nzType="edit" nzTheme="outline" class="mr-1"></span>
                  Sửa
                </li>
                <li nz-menu-item (click)="handleDisable(u)">
                  <span nz-icon nzType="stop" nzTheme="outline" class="mr-1" style="color: red"></span>
                  Vô hiệu hóa
                </li>
              </ul>
            </nz-dropdown-menu>
          </td>
          <td class="text-center">{{ (page - 1) * pageSize + i + 1 }}</td>
          <td class="text-center">{{ u.tenDangNhap || u.TenDangNhap || u.Code || '-' }}</td>
          <td>{{ u.hoTen || u.HoTen || '-' }}</td>
          <td>{{ u.tenQuyen || u.TenQuyen || (u.maQuyen || u.MaQuyen) || '-' }}</td>
          <td class="text-center">
            <app-status-pill [state]="u.trangThaiUser ?? u.isActive"></app-status-pill>
          </td>
        </tr>
      </tbody>
    </nz-table>
  </app-scroll>

  <ng-template #emptyTpl>
    <app-table-empty></app-table-empty>
  </ng-template>

  <nz-pagination *ngIf="total > pageSize" [nzTotal]="total" [nzPageSize]="pageSize" [(nzPageIndex)]="page"
    (nzPageIndexChange)="onPageChange($event)" [nzShowSizeChanger]="false"
    class="local-pager mt-3 flex justify-end"></nz-pagination>

  <!-- Create modal -->
  <nz-modal [(nzVisible)]="isCreateModalVisible" nzTitle="Thêm" (nzOnCancel)="isCreateModalVisible=false"
    [nzOkLoading]="saving" (nzOnOk)="create()" nzOkText="Lưu" nzCancelText="Hủy">
    <ng-container *nzModalContent>
      <form nz-form [formGroup]="form" class="modal-compact">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div class="flex flex-col">
            <label class="mb-1 text-sm">Mã quyền</label>
            <nz-select formControlName="MaQuyen" style="width:100%" nzAllowClear nzPlaceHolder="Chọn quyền">
              <nz-option *ngFor="let r of roles" [nzValue]="r.maQuyen"
                [nzLabel]="(r.maQuyen !== undefined && r.maQuyen !== null ? r.maQuyen : '') + (r.tenQuyen ? (' - ' + r.tenQuyen) : '')"></nz-option>
            </nz-select>
          </div>
          <div class="flex flex-col">
            <label class="mb-1 text-sm">Tên đăng nhập</label>
            <input nz-input formControlName="TenDangNhap" placeholder="Tên đăng nhập" />
          </div>

          <div class="flex flex-col">
            <label class="mb-1 text-sm">Họ tên</label>
            <input nz-input formControlName="HoTen" placeholder="Họ tên" />
          </div>

          <div class="flex flex-col">
            <label class="mb-1 text-sm">Email</label>
            <input nz-input formControlName="Email" placeholder="Email" />
          </div>

          <div class="flex flex-col">
            <label class="mb-1 text-sm">Số điện thoại</label>
            <input nz-input formControlName="SoDienThoai" placeholder="Số điện thoại" />
          </div>

          <div class="flex flex-col">
            <label class="mb-1 text-sm">Ngày sinh</label>
            <input nz-input type="date" formControlName="NgaySinh" />
          </div>

          <div class="flex flex-col">
            <label class="mb-1 text-sm">Giới tính</label>
            <nz-select formControlName="GioiTinh" style="width:100%">
              <nz-option [nzLabel]="'Nam'" [nzValue]="1"></nz-option>
              <nz-option [nzLabel]="'Nữ'" [nzValue]="2"></nz-option>
              <nz-option [nzLabel]="'Khác'" [nzValue]="3"></nz-option>
            </nz-select>
          </div>

          <div class="md:col-span-2 flex flex-col">
            <label class="mb-1 text-sm">Địa chỉ</label>
            <input nz-input formControlName="DiaChi" placeholder="Địa chỉ" />
          </div>

          <div class="md:col-span-2 flex flex-col">
            <label class="mb-1 text-sm">Ảnh đại diện</label>
            <input type="file" (change)="onFileChange($event)" accept="image/*" />
          </div>
        </div>
      </form>
    </ng-container>
  </nz-modal>

  <!-- Edit modal -->
  <nz-modal [(nzVisible)]="isEditModalVisible" nzTitle="Sửa người dùng" (nzOnCancel)="isEditModalVisible=false"
    [nzOkLoading]="saving" (nzOnOk)="update()" nzOkText="Lưu" nzCancelText="Hủy">
    <ng-container *nzModalContent>
      <form nz-form [formGroup]="form" class="modal-compact">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div class="flex flex-col">
            <label class="mb-1 text-sm">Mã quyền</label>
            <nz-select formControlName="MaQuyen" style="width:100%" nzAllowClear nzPlaceHolder="Chọn quyền">
              <nz-option *ngFor="let r of roles" [nzValue]="r.maQuyen"
                [nzLabel]="(r.maQuyen !== undefined && r.maQuyen !== null ? r.maQuyen : '') + (r.tenQuyen ? (' - ' + r.tenQuyen) : '')"></nz-option>
            </nz-select>
          </div>
          <div class="flex flex-col">
            <label class="mb-1 text-sm">Tên đăng nhập</label>
            <input nz-input formControlName="TenDangNhap" placeholder="Tên đăng nhập" />
          </div>

          <div class="flex flex-col">
            <label class="mb-1 text-sm">Họ tên</label>
            <input nz-input formControlName="HoTen" placeholder="Họ tên" />
          </div>

          <div class="flex flex-col">
            <label class="mb-1 text-sm">Email</label>
            <input nz-input formControlName="Email" placeholder="Email" />
          </div>

          <div class="flex flex-col">
            <label class="mb-1 text-sm">Trạng thái</label>
            <nz-select formControlName="TrangThai" style="width:100%">
              <nz-option [nzLabel]="'Hoạt động'" [nzValue]="true"></nz-option>
              <nz-option [nzLabel]="'Ngừng hoạt động'" [nzValue]="false"></nz-option>
            </nz-select>
          </div>

          <div class="flex flex-col">
            <label class="mb-1 text-sm">Số điện thoại</label>
            <input nz-input formControlName="SoDienThoai" placeholder="Số điện thoại" />
          </div>

          <div class="flex flex-col">
            <label class="mb-1 text-sm">Ngày sinh</label>
            <input nz-input type="date" formControlName="NgaySinh" />
          </div>

          <div class="flex flex-col">
            <label class="mb-1 text-sm">Giới tính</label>
            <nz-select formControlName="GioiTinh" style="width:100%">
              <nz-option [nzLabel]="'Nam'" [nzValue]="1"></nz-option>
              <nz-option [nzLabel]="'Nữ'" [nzValue]="2"></nz-option>
              <nz-option [nzLabel]="'Khác'" [nzValue]="3"></nz-option>
            </nz-select>
          </div>

          <div class="md:col-span-2 flex flex-col">
            <label class="mb-1 text-sm">Địa chỉ</label>
            <input nz-input formControlName="DiaChi" placeholder="Địa chỉ" />
          </div>

          <div class="md:col-span-2 flex flex-col">
            <label class="mb-1 text-sm">Ảnh đại diện</label>
            <input type="file" (change)="onFileChange($event)" accept="image/*" />
          </div>
        </div>
      </form>
    </ng-container>
  </nz-modal>
</div>
