<div>
  <div class="mb-3 p-3 rounded flex flex-wrap justify-between items-center gap-2">
    <div class="flex flex-wrap items-center gap-2">
      <input nz-input placeholder="Nhập để tìm kiếm" [(ngModel)]="keyword" class="border rounded px-2 py-1 w-full sm:w-[260px] min-w-0" (keyup.enter)="onSearch()" />

      <button nz-button nzType="primary" (click)="onSearch()" class="border rounded px-3 py-1 font-semibold text-[15px] flex items-center min-w-0 whitespace-nowrap">
        <i nz-icon nzType="search" class="mr-1 text-[16px] font-bold"></i>
        <span class="truncate">Tìm kiếm</span>
      </button>

      <button nz-button (click)="refreshList()" class="flex items-center border rounded px-3 py-1 font-semibold min-w-0 whitespace-nowrap">
        <i nz-icon nzType="reload" class="mr-1"></i>
        <span class="truncate">Làm mới</span>
      </button>

      <a nz-dropdown [nzDropdownMenu]="advSchedules" nzTrigger="click">
        <button nz-button class="flex items-center border rounded px-3 py-1 font-semibold min-w-0 whitespace-nowrap">
          <i nz-icon nzType="filter" class="mr-1"></i>
          <span class="truncate">Tìm nâng cao</span>
          <i nz-icon nzType="down" class="ml-1"></i>
        </button>
      </a>
    </div>

    <div class="flex items-center gap-2">
      <button nz-button nzType="primary" (click)="openCreate()"
        class="border rounded px-3 py-1 font-semibold text-[15px] flex items-center">
        <i nz-icon nzType="plus" class="mr-1 text-[16px] font-bold"></i>
        <span>Tạo buổi</span>
      </button>
      <button *ngIf="setOfCheckedId.size > 0" nz-button nzType="default" nzDanger (click)="deleteSelected()"
        class="border rounded px-3 py-1 flex items-center">
        <i nz-icon nzType="stop" class="mr-1"></i>
        <span>Vô hiệu hóa đã chọn ({{ setOfCheckedId.size }})</span>
      </button>
    </div>
  </div>

  <nz-dropdown-menu #advSchedules="nzDropdownMenu">
    <div nz-menu class="p-3" style="min-width:320px">
      <div class="text-sm font-semibold mb-2">Bộ lọc nâng cao</div>

      <div class="grid grid-cols-1 gap-2">
        <div class="flex flex-col">
          <label class="mb-1 font-medium">Mã lớp HP</label>
          <input nz-input placeholder="Mã lớp HP" [(ngModel)]="filterMaLopHocPhan" />
        </div>

        <div class="flex flex-col">
          <label class="mb-1 font-medium">Ngày học</label>
          <input nz-input type="date" placeholder="Ngày học" [(ngModel)]="filterNgayHoc" />
        </div>

        <div class="flex flex-col">
          <label class="mb-1 font-medium">Tiết bắt đầu</label>
          <input nz-input type="number" placeholder="Tiết bắt đầu" [(ngModel)]="filterTietBatDau" />
        </div>

        <div class="flex flex-col">
          <label class="mb-1 font-medium">Mã phòng</label>
          <input nz-input placeholder="Mã phòng" [(ngModel)]="filterMaPhong" />
        </div>

        <div class="flex flex-col">
          <label class="mb-1 font-medium">Tên phòng</label>
          <input nz-input placeholder="Tên phòng" [(ngModel)]="filterTenPhong" />
        </div>

        <div class="flex flex-col">
          <label class="mb-1 font-medium">Trạng thái</label>
          <nz-select [(ngModel)]="filterTrangThai" nzAllowClear nzPlaceHolder="Chọn trạng thái">
            <!-- <nz-option [nzLabel]="'Tất cả'" [nzValue]="''"></nz-option> -->
            <nz-option [nzLabel]="'Hoạt động'" [nzValue]="true"></nz-option>
            <nz-option [nzLabel]="'Ngừng hoạt động'" [nzValue]="false"></nz-option>
          </nz-select>
        </div>
      </div>

      <div class="flex justify-end gap-2 mt-3">
        <button nz-button (click)="refreshList()">Làm mới</button>
        <button nz-button nzType="primary" (click)="onFilterChange()">Tìm kiếm</button>
      </div>
    </div>
  </nz-dropdown-menu>

  <ng-container>
    <app-scroll-table [height]="'450px'">
      <nz-table [nzData]="schedules" [nzLoading]="loading" nzBordered [nzFrontPagination]="false" [nzNoResult]="emptyTpl"
        (nzCurrentPageDataChange)="onCurrentPageDataChange($event)">
      <thead>
        <tr>
          <th [nzChecked]="checked" [nzIndeterminate]="indeterminate" (nzCheckedChange)="onAllChecked($event)"
            nzWidth="48px"></th>
          <th style="width:64px; text-align:center">Thao tác</th>
          <th style="font-weight:bold; cursor:pointer;" (click)="changeSort('MaBuoi')">Mã buổi
            <i nz-icon [nzType]="sortBy === 'MaBuoi' ? (sortDir === 'ASC' ? 'caret-up' : 'caret-down') : 'caret-up'" class="ml-1 text-sm"></i>
          </th>
          <th style="font-weight:bold; cursor:pointer;" (click)="changeSort('MaLopHocPhan')">Mã lớp HP
            <i nz-icon [nzType]="sortBy === 'MaLopHocPhan' ? (sortDir === 'ASC' ? 'caret-up' : 'caret-down') : 'caret-up'" class="ml-1 text-sm"></i>
          </th>
          <th style="font-weight:bold; cursor:pointer;" (click)="changeSort('TenMonHoc')">Môn học
            <i nz-icon [nzType]="sortBy === 'TenMonHoc' ? (sortDir === 'ASC' ? 'caret-up' : 'caret-down') : 'caret-up'" class="ml-1 text-sm"></i>
          </th>
          <th style="font-weight:bold; cursor:pointer;" (click)="changeSort('TenPhong')">Phòng
            <i nz-icon [nzType]="sortBy === 'TenPhong' ? (sortDir === 'ASC' ? 'caret-up' : 'caret-down') : 'caret-up'" class="ml-1 text-sm"></i>
          </th>
          <th style="font-weight:bold; cursor:pointer;" (click)="changeSort('NgayHoc')">Ngày học
            <i nz-icon [nzType]="sortBy === 'NgayHoc' ? (sortDir === 'ASC' ? 'caret-up' : 'caret-down') : 'caret-up'" class="ml-1 text-sm"></i>
          </th>
          <th style="font-weight:bold; cursor:pointer;" (click)="changeSort('TietBatDau')">Tiết bắt đầu
            <i nz-icon [nzType]="sortBy === 'TietBatDau' ? (sortDir === 'ASC' ? 'caret-up' : 'caret-down') : 'caret-up'" class="ml-1 text-sm"></i>
          </th>
          <th style="font-weight:bold; cursor:pointer;" (click)="changeSort('SoTiet')">Số tiết
            <i nz-icon [nzType]="sortBy === 'SoTiet' ? (sortDir === 'ASC' ? 'caret-up' : 'caret-down') : 'caret-up'" class="ml-1 text-sm"></i>
          </th>
          <th>Trạng thái</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let s of schedules">
          <td [nzChecked]="setOfCheckedId.has(getRowKey(s))" (nzCheckedChange)="onItemChecked(getRowKey(s), $event)"
            nzWidth="48px"></td>
          <td class="text-center">
            <a nz-dropdown [nzDropdownMenu]="menu" nzTrigger="hover">
              <span nz-icon nzType="bars" nzTheme="outline"></span>
            </a>
            <nz-dropdown-menu #menu="nzDropdownMenu">
              <ul nz-menu nzSelectable>
                <li nz-menu-item (click)="openEdit(s)">
                  <span nz-icon nzType="edit" class="mr-2"></span>
                  Chỉnh sửa
                </li>
                <li nz-menu-item (click)="delete(s)">
                  <span nz-icon nzType="stop" class="mr-2" style="color:#cf1322"></span>
                  Vô hiệu hóa
                </li>
              </ul>
            </nz-dropdown-menu>
          </td>
          <td>{{ s.maBuoi }}</td>
          <td>{{ s.maLopHocPhan }}</td>
          <td>{{ s.tenMonHoc || '-' }}</td>
          <td>{{ s.tenPhong || s.maPhong }}</td>
          <td>{{ formatDisplayDate(s.ngayHoc) }}</td>
          <td>{{ s.tietBatDau }}</td>
          <td>{{ s.soTiet }}</td>
          <td class="text-center">
            <app-status-pill [state]="s.trangThai"></app-status-pill>
          </td>
        </tr>
      </tbody>
      </nz-table>
    </app-scroll-table>

    <nz-pagination class="mt-3 flex justify-end" [nzTotal]="total" [nzPageSize]="pageSize" [(nzPageIndex)]="page"
      (nzPageIndexChange)="onPageChange($event)">
    </nz-pagination>
  </ng-container>

  <!-- Empty state -->
  <ng-template #emptyTpl>
    <app-table-empty></app-table-empty>
  </ng-template>
  <nz-modal [(nzVisible)]="isCreateVisible" nzTitle="Tạo buổi học" (nzOnCancel)="cancel()" (nzOnOk)="create()"
    [nzOkLoading]="creating" nzOkText="Lưu" nzCancelText="Hủy">
    <ng-container *nzModalContent>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div class="flex flex-col">
          <label class="mb-1">Mã lớp HP</label>
          <nz-select [(ngModel)]="newSchedule.MaLopHocPhan" nzShowSearch nzAllowClear nzPlaceHolder="Chọn lớp HP">
            <nz-option *ngFor="let c of coursesOptions" [nzLabel]="c.label" [nzValue]="c.value"></nz-option>
          </nz-select>
        </div>
        <div class="flex flex-col">
          <label class="mb-1">Mã phòng</label>
          <nz-select [(ngModel)]="newSchedule.MaPhong" nzShowSearch nzAllowClear nzPlaceHolder="Chọn phòng">
            <nz-option *ngFor="let r of roomsOptions" [nzLabel]="r.label" [nzValue]="r.value"></nz-option>
          </nz-select>
        </div>
        <div><label>Ngày học</label><input nz-input type="date" [(ngModel)]="newSchedule.NgayHoc" /></div>
        <div><label>Tiết bắt đầu</label><input nz-input type="number" [(ngModel)]="newSchedule.TietBatDau" /></div>
        <div><label>Số tiết</label><input nz-input type="number" [(ngModel)]="newSchedule.SoTiet" /></div>
        <div><label>Trạng thái</label>
          <nz-select [(ngModel)]="newSchedule.TrangThai">
            <nz-option [nzLabel]="'Hoạt động'" [nzValue]="true"></nz-option>
            <nz-option [nzLabel]="'Ngừng hoạt động'" [nzValue]="false"></nz-option>
          </nz-select>
        </div>
      </div>
    </ng-container>
  </nz-modal>

  <nz-modal [(nzVisible)]="isEditVisible" nzTitle="Sửa buổi học" (nzOnCancel)="cancel()" (nzOnOk)="update()"
    [nzOkLoading]="updating" nzOkText="Lưu" nzCancelText="Hủy">
    <ng-container *nzModalContent>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div><label>Mã buổi</label><input nz-input [(ngModel)]="selectedSchedule.MaBuoi" disabled /></div>
        <div class="flex flex-col">
          <label class="mb-1">Mã phòng</label>
          <nz-select [(ngModel)]="selectedSchedule.MaPhong" nzShowSearch nzAllowClear nzPlaceHolder="Chọn phòng">
            <nz-option *ngFor="let r of roomsOptions" [nzLabel]="r.label" [nzValue]="r.value"></nz-option>
          </nz-select>
        </div>
        <div><label>Ngày học</label><input nz-input type="date" [(ngModel)]="selectedSchedule.NgayHoc" /></div>
        <div><label>Tiết bắt đầu</label><input nz-input type="number" [(ngModel)]="selectedSchedule.TietBatDau" /></div>
        <div><label>Số tiết</label><input nz-input type="number" [(ngModel)]="selectedSchedule.SoTiet" /></div>
        <div><label>Ghi chú</label><input nz-input [(ngModel)]="selectedSchedule.GhiChu" /></div>
        <div><label>Trạng thái</label>
          <nz-select [(ngModel)]="selectedSchedule.TrangThai">
            <nz-option [nzLabel]="'Hoạt động'" [nzValue]="true"></nz-option>
            <nz-option [nzLabel]="'Ngừng hoạt động'" [nzValue]="false"></nz-option>
          </nz-select>
        </div>
      </div>
    </ng-container>
  </nz-modal>
</div>
