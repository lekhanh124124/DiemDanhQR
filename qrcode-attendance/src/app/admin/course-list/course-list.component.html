<div class="mb-3 p-3 rounded flex flex-wrap justify-between items-center gap-2">
  <div class="flex flex-wrap items-center gap-2">
    <input nz-input placeholder="Nhập để tìm kiếm" [(ngModel)]="searchTerm" class="border rounded px-2 py-1 w-full sm:w-[260px] min-w-0" (keyup.enter)="applySearchTerm()" />

    <button nz-button nzType="primary" (click)="applySearchTerm()" class="border rounded px-3 py-1 font-semibold text-[15px] flex items-center min-w-0 whitespace-nowrap">
      <i nz-icon nzType="search" class="mr-1 text-[16px] font-bold"></i>
      <span class="truncate">Tìm kiếm</span>
    </button>

    <button nz-button (click)="refreshList()" class="flex items-center border rounded px-3 py-1 font-semibold min-w-0 whitespace-nowrap">
      <i nz-icon nzType="reload" class="mr-1"></i>
      <span class="truncate">Làm mới</span>
    </button>

    <a nz-dropdown [nzDropdownMenu]="advCourses" nzTrigger="click">
      <button nz-button class="flex items-center border rounded px-3 py-1 font-semibold min-w-0 whitespace-nowrap">
        <i nz-icon nzType="filter" class="mr-1"></i>
        <span class="truncate">Tìm nâng cao</span>
        <i nz-icon nzType="down" class="ml-1"></i>
      </button>
    </a>
  </div>

  <div class="flex items-center gap-2">
    <button nz-button nzType="primary" (click)="openCreateCourse()"
      class="border rounded px-3 py-1 font-semibold text-[15px] flex items-center">
      <i nz-icon nzType="plus" class="mr-1 text-[16px] font-bold"></i>
      <span>Tạo lớp học phần</span>
    </button>
    <button *ngIf="setOfCheckedId.size > 0" nz-button nzType="default" nzDanger (click)="deleteSelected()"
      class="border rounded px-3 py-1 flex items-center">
      <i nz-icon nzType="stop" class="mr-1"></i>
      <span>Vô hiệu hóa đã chọn ({{ setOfCheckedId.size }})</span>
    </button>
  </div>
</div>


<nz-dropdown-menu #advCourses="nzDropdownMenu">
  <div nz-menu class="p-3" style="min-width:320px">
    <div class="text-sm font-semibold mb-2">Bộ lọc nâng cao</div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
      <div class="flex flex-col">
        <label class="mb-1 font-medium">Mã lớp học phần</label>
        <input nz-input placeholder="Mã lớp học phần" [(ngModel)]="filterMaLopHocPhan" />
      </div>
      <div class="flex flex-col">
        <label class="mb-1 font-medium">Tên lớp học phần</label>
        <input nz-input placeholder="Tên lớp học phần" [(ngModel)]="filterTenLopHocPhan" />
      </div>
      <div class="flex flex-col">
        <label class="mb-1 font-medium">Trạng thái</label>
        <nz-select [(ngModel)]="filterTrangThai" nzAllowClear nzPlaceHolder="Chọn trạng thái">
          <nz-option [nzLabel]="'Hoạt động'" [nzValue]="true"></nz-option>
          <nz-option [nzLabel]="'Ngừng hoạt động'" [nzValue]="false"></nz-option>
        </nz-select>
      </div>

      <div class="flex flex-col">
        <label class="mb-1 font-medium">Mã môn học</label>
        <input nz-input placeholder="Mã môn học" [(ngModel)]="filterMaMonHoc" />
      </div>
      <div class="flex flex-col">
        <label class="mb-1 font-medium">Tên môn học</label>
        <input nz-input placeholder="Tên môn học" [(ngModel)]="filterTenMonHoc" />
      </div>
      <div class="flex flex-col">
        <label class="mb-1 font-medium">Mã giảng viên</label>
        <input nz-input placeholder="Mã giảng viên" [(ngModel)]="filterMaGiangVien" />
      </div>

      <div class="flex flex-col">
        <label class="mb-1 font-medium">Tên giảng viên</label>
        <input nz-input placeholder="Tên giảng viên" [(ngModel)]="filterTenGiangVien" />
      </div>
      <div class="flex flex-col">
        <label class="mb-1 font-medium">Năm học</label>
        <nz-select [(ngModel)]="filterNamHoc" nzAllowClear nzPlaceHolder="Chọn năm học" nzShowSearch>
          <nz-option *ngFor="let y of years" [nzLabel]="y.label" [nzValue]="y.value"></nz-option>
        </nz-select>
      </div>
      <div class="flex flex-col">
        <label class="mb-1 font-medium">Học kỳ</label>
        <nz-select [(ngModel)]="filterHocKy" nzAllowClear nzPlaceHolder="Chọn học kỳ" nzShowSearch>
          <nz-option *ngFor="let s of hocKyOptions" [nzLabel]="s.label" [nzValue]="s.value"></nz-option>
        </nz-select>
      </div>
      
    </div>

    <div class="flex justify-end gap-2 mt-3">
      <button nz-button (click)="refreshList()" class="mr-2">Làm mới</button>
      <button nz-button nzType="primary" (click)="onFilterChange()">Tìm kiếm</button>
    </div>
  </div>
</nz-dropdown-menu>


<app-scroll-table class="course-list-table" [height]="'450px'">
  <nz-table [nzBordered]="true" [nzLoading]="loading" [nzData]="courses" [nzFrontPagination]="false"
    [nzShowPagination]="false" (nzCurrentPageDataChange)="onCurrentPageDataChange($event)">
  <thead>
    <tr>
      <th [nzChecked]="checked" [nzIndeterminate]="indeterminate" (nzCheckedChange)="onAllChecked($event)" nzWidth="48px"></th>
      <th style="text-align: center;">Thao tác</th>
      <th>STT</th>
      <th style="font-weight: bold; text-align: center; cursor: pointer;" (click)="changeSort('MaMonHoc')">Mã môn học
        <i nz-icon [nzType]="sortBy === 'MaMonHoc' ? (sortDir === 'ASC' ? 'caret-up' : 'caret-down') : 'caret-up'" class="ml-1 text-sm"></i>
      </th>
      <th style="font-weight: bold; text-align: center; cursor: pointer;" (click)="changeSort('TenMonHoc')">Tên môn học
        <i nz-icon [nzType]="sortBy === 'TenMonHoc' ? (sortDir === 'ASC' ? 'caret-up' : 'caret-down') : 'caret-up'" class="ml-1 text-sm"></i>
      </th>
      <th style="font-weight: bold; text-align: center; cursor: pointer;" (click)="changeSort('maLopHocPhan')">Mã lớp
        học phần <i nz-icon [nzType]="sortBy === 'maLopHocPhan' ? (sortDir === 'ASC' ? 'caret-up' : 'caret-down') : 'caret-up'" class="ml-1 text-sm"></i>
      </th>
      <th style="font-weight: bold; text-align: center; cursor: pointer;" (click)="changeSort('NamHoc')">Năm học
        <i nz-icon [nzType]="sortBy === 'NamHoc' ? (sortDir === 'ASC' ? 'caret-up' : 'caret-down') : 'caret-up'" class="ml-1 text-sm"></i>
      </th>
      <th>Trạng thái</th>
    </tr>
  </thead>

  <tbody>
    <tr *ngIf="!courses.length">
      <td colspan="8" class="text-center"><app-table-empty></app-table-empty></td>
    </tr>
    <ng-container *ngFor="let course of courses; index as i">
      <tr>
        <td [nzChecked]="setOfCheckedId.has(getRowKey(course))" (nzCheckedChange)="onItemChecked(getRowKey(course), $event)" nzWidth="48px"></td>
        <td class="text-center flex items-center justify-center">
          <button nz-button nzType="text" class="p-0 mr-2" (click)="toggleExpand(course); $event.stopPropagation()">
            <i nz-icon [nzType]="isExpanded(course) ? 'caret-up' : 'caret-down'" class="text-blue-600"></i>
          </button>
          <a nz-dropdown [nzDropdownMenu]="menu" nzTrigger="hover">
            <span nz-icon nzType="bars" nzTheme="outline"></span>
          </a>
          <nz-dropdown-menu #menu="nzDropdownMenu">
            <ul nz-menu nzSelectable>
              <li nz-menu-item (click)="openEditCourse(course)">
                <span nz-icon nzType="edit" class="mr-2"></span>
                Chỉnh sửa
              </li>
              <li nz-menu-item (click)="openDetail(course)">
                <span nz-icon nzType="eye" class="mr-2"></span>
                Xem chi tiết
              </li>
              <li nz-menu-item (click)="goToScheduleForCourse(course)">
                <span nz-icon nzType="calendar" class="mr-2"></span>
                Xem buổi học
              </li>
              <li nz-menu-item (click)="confirmAutoGenerateCourse(course)">
                <span nz-icon nzType="plus" class="mr-2"></span>
                Tạo buổi học tự động
              </li>
              <li nz-menu-item (click)="confirmDisableCourse(course)">
                <span nz-icon nzType="stop" class="mr-2"></span>
                Vô hiệu hóa
              </li>
            </ul>
          </nz-dropdown-menu>
        </td>
        <td>{{ (page - 1) * pageSize + i + 1 }}</td>
        <td>{{ course.maMonHoc || '-' }}</td>
        <td>{{ course.tenMonHoc || '-' }}</td>
        <td>{{ course.maLopHocPhan || course.maLop || '-' }}</td>
        <td>{{ course.namHoc || course.NamHoc || '-' }}</td>
        <td><app-status-pill [state]="course.trangThai"></app-status-pill></td>
      </tr>

      <tr *ngIf="isExpanded(course)">
        <td colspan="8" class="p-0">
          <div class="m-3 border rounded overflow-hidden">
            <div class="bg-blue-400 text-white p-3 font-semibold">Thông tin chi tiết</div>
            <div class="p-3 bg-gray-50">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <div><b>Số tín chỉ:</b> {{ course.soTinChi || '-' }}</div>
                <div><b>Số tiết:</b> {{ course.soTiet || '-' }}</div>
                <div><b>Giảng viên:</b> {{ course.tenGiangVien || course.maGiangVien || '-' }}</div>
                <div><b>Mã giảng viên:</b> {{ course.maGiangVien || '-' }}</div>
                <div><b>Học kỳ:</b> {{ course.hocKy || course.MaHocKy || course.maHocKy || '-' }}</div>
                <div><b>Tên lớp HP:</b> {{ course.tenLopHocPhan || course.tenLop || '-' }}</div>
                <div><b>Mã học kỳ:</b> {{ course.maHocKy || course.MaHocKy || '-' }}</div>
              </div>
            </div>
          </div>
        </td>
      </tr>
    </ng-container>
  </tbody>
  </nz-table>
</app-scroll-table>

<nz-pagination [nzTotal]="total" [nzPageSize]="pageSize" [(nzPageIndex)]="page"
  (nzPageIndexChange)="onPageChange($event)" [nzShowSizeChanger]="false" class="mt-3 flex justify-end">
</nz-pagination>

<!-- Modal: Chi tiết lớp học phần (danh sách sinh viên) -->
<nz-modal [(nzVisible)]="isDetailVisible" nzTitle="Danh sách sinh viên - {{ detailCourseCode }}"
  (nzOnCancel)="isDetailVisible=false" nzCancelText="Hủy">
  <ng-container *nzModalContent>
    <div *ngIf="detailLoading" class="text-center py-6">Đang tải...</div>
    <div *ngIf="!detailLoading">
      <div class="mb-3 flex justify-between items-center">
        <div> Mã lớp: <b>{{ detailCourseCode }}</b></div>
        <div class="flex items-center gap-2">
          <button nz-button (click)="openImportStudents({ maLopHocPhan: detailCourseCode })"><i nz-icon nzType="upload"
              class="mr-1"></i>Nhập file</button>
          <button nz-button nzType="primary" (click)="openAddStudent({ maLopHocPhan: detailCourseCode })"><i nz-icon
              nzType="user-add" class="mr-1"></i>Thêm SV</button>
        </div>
      </div>
      <nz-table [nzData]="detailStudents" [nzFrontPagination]="false" [nzShowPagination]="false" [nzBordered]="true" [nzNoResult]="emptyTpl">
        <thead>
          <tr>
            <th>STT</th>
            <th>Mã sinh viên</th>
            <th>Họ tên</th>
            <th style="text-align: center;">Hành động</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngIf="!detailStudents.length">
            <td colspan="4" class="text-center text-gray-500">Không có sinh viên</td>
          </tr>
          <tr *ngFor="let s of detailStudents; index as i">
            <td>{{ i + 1 }}</td>
            <td>{{ s.maSinhVien }}</td>
            <td>{{ s.hoTen }}</td>
            <td class="text-center">
              <button nz-button nzType="default" nzDanger (click)="confirmRemoveStudent(s.maSinhVien)"
                [disabled]="removingStudents.has(s.maSinhVien)">
                <i nz-icon nzType="delete" class="mr-1"></i>
                <span *ngIf="!removingStudents.has(s.maSinhVien)">Xóa</span>
                <span *ngIf="removingStudents.has(s.maSinhVien)">Đang xóa...</span>
              </button>
            </td>
          </tr>
        </tbody>
      </nz-table>
      <ng-template #emptyTpl>
        <div style="padding:12px; text-align:center; color:var(--nz-color-text-disabled)"></div>
      </ng-template>
    </div>
  </ng-container>
</nz-modal>

<!-- Modal: Tạo lớp học phần -->
<nz-modal [(nzVisible)]="isCreateCourseVisible" nzTitle="Tạo lớp học phần" (nzOnCancel)="cancelModals()"
  (nzOnOk)="createCourse()" [nzOkLoading]="creating" nzOkText="Lưu" nzCancelText="Hủy">
  <ng-container *nzModalContent>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

      <div class="flex flex-col">
        <label class="mb-2 font-medium text-gray-700">Tên lớp HP</label>
        <input nz-input [(ngModel)]="newCourse.TenLopHocPhan" placeholder="Nhập tên lớp học phần" />
      </div>

      <div class="flex flex-col">
        <label class="mb-2 font-medium text-gray-700">Mã môn học</label>
        <input nz-input [(ngModel)]="newCourse.MaMonHoc" [nzAutocomplete]="autoMaMon"
          placeholder="Nhập hoặc chọn môn học" />
        <nz-autocomplete #autoMaMon>
          <nz-auto-option *ngFor="let s of subjects" [nzValue]="s.value">{{ s.label }}</nz-auto-option>
        </nz-autocomplete>
      </div>

      <div class="flex flex-col">
        <label class="mb-2 font-medium text-gray-700">Mã giảng viên</label>
        <input nz-input [(ngModel)]="newCourse.MaGiangVien" [nzAutocomplete]="autoGiangVien"
          placeholder="Nhập hoặc chọn giảng viên" />
        <nz-autocomplete #autoGiangVien>
          <nz-auto-option *ngFor="let g of lecturers" [nzValue]="g.value">{{ g.label }}</nz-auto-option>
        </nz-autocomplete>
      </div>

      <div class="flex flex-col">
        <label class="mb-2 font-medium text-gray-700">Mã học kỳ</label>
        <input nz-input [(ngModel)]="newCourse.MaHocKy" [nzAutocomplete]="autoHocKy"
          placeholder="Nhập hoặc chọn học kỳ" />
        <nz-autocomplete #autoHocKy>
          <nz-auto-option *ngFor="let s of semesters" [nzValue]="s.value">{{ s.label }}</nz-auto-option>
        </nz-autocomplete>
      </div>

      <div class="flex flex-col">
        <label class="mb-2 font-medium text-gray-700">Trạng thái</label>
        <nz-select [(ngModel)]="newCourse.TrangThai" nzPlaceHolder="Chọn trạng thái">
          <nz-option [nzLabel]="'Hoạt động'" [nzValue]="true"></nz-option>
          <nz-option [nzLabel]="'Ngừng hoạt động'" [nzValue]="false"></nz-option>
        </nz-select>
      </div>
    </div>
  </ng-container>
</nz-modal>

<!-- Modal: Import danh sách sinh viên -->
<nz-modal [(nzVisible)]="isImportVisible" nzTitle="Nhập danh sách sinh viên" (nzOnCancel)="cancelImportModal()"
  [nzFooter]="importFooter" nzCancelText="Hủy">
  <ng-container *nzModalContent>
    <div class="grid grid-cols-1 gap-3">
      <div class="flex items-center gap-3">
        <label class="font-medium">Mã lớp HP</label>
        <input nz-input [(ngModel)]="importCourseCode" disabled style="max-width: 260px;" />
      </div>
      <div class="flex flex-col">
        <label class="font-medium mb-1">Chọn file (.csv, .txt, .xlsx, .xls)</label>
        <input type="file" accept=".csv,.txt,.xlsx,.xls" (change)="onImportFileChange($event)" />
        <small class="text-gray-500 mt-1">Định dạng đơn giản: mỗi dòng 1 Mã sinh viên hoặc CSV cột đầu tiên là
          MaSinhVien. Ví dụ: sinhvien01</small>
        <small class="text-gray-500">Excel: lấy sheet đầu tiên; nếu có tiêu đề cột MaSinhVien sẽ dùng cột đó, không thì
          dùng cột đầu tiên.</small>
        <small *ngIf="importFileName" class="text-gray-600 mt-1">Đã chọn: {{ importFileName }}</small>
      </div>

      <div *ngIf="importStudents.length" class="mt-2">
        <div class="mb-2 text-sm">Số dòng đọc được: <b>{{ importStudents.length }}</b></div>
        <nz-table [nzData]="importStudents" [nzFrontPagination]="false" [nzShowPagination]="false" [nzBordered]="true">
          <thead>
            <tr>
              <th style="width: 260px;">Mã sinh viên</th>
              <th>Trạng thái</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let it of importStudents">
              <td>{{ it.code }}</td>
              <td>
                <ng-container [ngSwitch]="it.status">
                  <span *ngSwitchCase="'pending'" class="text-blue-600">Đang thêm...</span>
                  <span *ngSwitchCase="'success'" class="text-green-700">{{ it.message || 'Đã thêm' }}</span>
                  <span *ngSwitchCase="'error'" class="text-red-600">{{ it.message || 'Lỗi' }}</span>
                  <span *ngSwitchDefault>-</span>
                </ng-container>
              </td>
            </tr>
          </tbody>
        </nz-table>
      </div>
    </div>
  </ng-container>
</nz-modal>

<ng-template #importFooter>
  <button nz-button (click)="cancelImportModal()" [disabled]="importing">Đóng</button>
  <button nz-button nzType="primary" (click)="startImport()" [disabled]="!importStudents.length || importing">Bắt đầu
    import</button>
</ng-template>

<!-- Modal: Sửa lớp học phần -->
<nz-modal [(nzVisible)]="isEditCourseVisible" nzTitle="Sửa lớp học phần" (nzOnCancel)="cancelModals()"
  (nzOnOk)="updateCourse()" [nzOkLoading]="updating" nzOkText="Lưu" nzCancelText="Hủy">
  <ng-container *nzModalContent>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="flex flex-col">
        <label class="mb-2 font-medium text-gray-700">Mã lớp HP</label>
        <input nz-input [(ngModel)]="selectedCourse.MaLopHocPhan" disabled />
      </div>

      <div class="flex flex-col">
        <label class="mb-2 font-medium text-gray-700">Tên lớp HP</label>
        <input nz-input [(ngModel)]="selectedCourse.TenLopHocPhan" placeholder="Nhập tên lớp học phần" />
      </div>

      <div class="flex flex-col">
        <label class="mb-2 font-medium text-gray-700">Mã môn học</label>
        <nz-select [(ngModel)]="selectedCourse.MaMonHoc" nzAllowClear nzShowSearch nzPlaceHolder="Chọn môn học">
          <nz-option *ngFor="let s of subjects" [nzLabel]="s.label" [nzValue]="s.value"></nz-option>
        </nz-select>
      </div>

      <div class="flex flex-col">
        <label class="mb-2 font-medium text-gray-700">Mã giảng viên</label>
        <nz-select [(ngModel)]="selectedCourse.MaGiangVien" nzAllowClear nzShowSearch nzPlaceHolder="Chọn giảng viên">
          <nz-option *ngFor="let g of lecturers" [nzLabel]="g.label" [nzValue]="g.value"></nz-option>
        </nz-select>
      </div>

      <div class="flex flex-col">
        <label class="mb-2 font-medium text-gray-700">Mã học kỳ</label>
        <input nz-input type="number" [(ngModel)]="selectedCourse.MaHocKy" placeholder="Nhập mã học kỳ" />
      </div>

      <div class="flex flex-col">
        <label class="mb-2 font-medium text-gray-700">Trạng thái</label>
        <nz-select [(ngModel)]="selectedCourse.TrangThai" nzPlaceHolder="Chọn trạng thái">
          <nz-option [nzLabel]="'Hoạt động'" [nzValue]="true"></nz-option>
          <nz-option [nzLabel]="'Ngừng hoạt động'" [nzValue]="false"></nz-option>
        </nz-select>
      </div>
    </div>
  </ng-container>
</nz-modal>

<!-- Modal: Thêm sinh viên vào lớp -->
<nz-modal [(nzVisible)]="isAddStudentVisible" nzTitle="Thêm sinh viên vào lớp" (nzOnCancel)="cancelModals()"
  (nzOnOk)="addStudent()" [nzOkLoading]="adding" nzOkText="Lưu" nzCancelText="Hủy">
  <ng-container *nzModalContent>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
      <div><label>Mã lớp HP</label><input nz-input [(ngModel)]="addStudentModel.MaLopHocPhan" disabled /></div>
      <div><label>Mã sinh viên</label><input nz-input [(ngModel)]="addStudentModel.MaSinhVien" /></div>
      <div><label>Ngày tham gia</label><input nz-input type="date" [(ngModel)]="addStudentModel.NgayThamGia" /></div>
      <div><label>Trạng thái</label>
        <nz-select [(ngModel)]="addStudentModel.TrangThai">
          <nz-option [nzLabel]="'Hoạt động'" [nzValue]="true"></nz-option>
          <nz-option [nzLabel]="'Ngừng hoạt động'" [nzValue]="false"></nz-option>
        </nz-select>
      </div>
    </div>
  </ng-container>
</nz-modal>
