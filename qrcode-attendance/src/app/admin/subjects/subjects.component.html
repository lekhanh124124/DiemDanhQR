<div class="mb-3 flex flex-wrap justify-between items-center gap-2">
  <div class="flex flex-wrap items-center gap-2">
    <input nz-input placeholder="Nhập để tìm kiếm" [(ngModel)]="keyword" class="border rounded px-2 py-1 w-full sm:w-[260px] min-w-0" (keyup.enter)="onSearch()" />
    <button nz-button nzType="primary" (click)="onSearch()" class="border rounded px-3 py-1 font-semibold text-[15px] flex items-center min-w-0 whitespace-nowrap">
      <i nz-icon nzType="search" class="mr-1 text-[16px] font-bold"></i>
      <span class="truncate">Tìm kiếm</span>
    </button>

    <button nz-button (click)="refreshList()" class="flex items-center border rounded px-3 py-1 font-semibold min-w-0 whitespace-nowrap">
      <i nz-icon nzType="reload" class="mr-1"></i>
      <span class="truncate">Làm mới</span>
    </button>

    <a nz-dropdown [nzDropdownMenu]="advSubjects" nzTrigger="click">
      <button nz-button class="flex items-center border rounded px-3 py-1 font-semibold min-w-0 whitespace-nowrap">
        <i nz-icon nzType="filter" class="mr-1"></i>
        <span class="truncate">Tìm nâng cao</span>
        <i nz-icon nzType="down" class="ml-1"></i>
      </button>
    </a>
  </div>

  <div class="flex items-center gap-2">
    <button nz-button nzType="primary" (click)="openCreate()"
      class="border rounded px-3 py-1 font-semibold text-[15px] flex items-center">
      <i nz-icon nzType="plus" class="mr-1 text-[16px] font-bold"></i>
      <span>Thêm môn học</span>
    </button>
    <button *ngIf="setOfCheckedId.size > 0" nz-button nzType="default" nzDanger (click)="deleteSelected()"
      class="border rounded px-3 py-1 flex items-center">
      <i nz-icon nzType="stop" class="mr-1"></i>
      <span>Vô hiệu hóa đã chọn ({{ setOfCheckedId.size }})</span>
    </button>
  </div>
</div>

  <nz-dropdown-menu #advSubjects="nzDropdownMenu">
  <div nz-menu class="p-3" style="min-width:320px">
    <div class="text-sm font-semibold mb-2">Bộ lọc nâng cao</div>

    <div class="grid grid-cols-1 gap-2">
      <div class="flex flex-col">
        <label class="mb-1 font-medium">Mã môn học</label>
        <input nz-input placeholder="Mã môn học" [(ngModel)]="filterMaMonHoc" />
      </div>

      <div class="flex flex-col">
        <label class="mb-1 font-medium">Tên môn học</label>
        <input nz-input placeholder="Tên môn học" [(ngModel)]="filterTenMonHoc" />
      </div>

      <div class="flex flex-col">
        <label class="mb-1 font-medium">Số tín chỉ</label>
        <input nz-input type="number" placeholder="Số tín chỉ" [(ngModel)]="filterSoTinChi" />
      </div>

      <div class="flex flex-col">
        <label class="mb-1 font-medium">Số tiết</label>
        <input nz-input type="number" placeholder="Số tiết" [(ngModel)]="filterSoTiet" />
      </div>

      <div class="flex flex-col">
        <label class="mb-1 font-medium">Loại môn</label>
        <nz-select [(ngModel)]="filterLoaiMon" style="width:100%" nzAllowClear nzPlaceHolder="Chọn loại môn">
          <nz-option nzLabel="Lý thuyết" [nzValue]="1"></nz-option>
          <nz-option nzLabel="Thực hành" [nzValue]="2"></nz-option>
          <nz-option nzLabel="Lý thuyết & Thực hành" [nzValue]="3"></nz-option>
        </nz-select>
      </div>

      <div class="flex flex-col">
        <label class="mb-1 font-medium">Trạng thái</label>
        <nz-select [(ngModel)]="filterTrangThai" style="width:100%" nzAllowClear nzPlaceHolder="Chọn trạng thái">
          <!-- <nz-option nzLabel="Tất cả" [nzValue]="''"></nz-option> -->
          <nz-option nzLabel="Hoạt động" [nzValue]="true"></nz-option>
          <nz-option nzLabel="Ngừng hoạt động" [nzValue]="false"></nz-option>
        </nz-select>
      </div>
    </div>

    <div class="flex justify-end gap-2 mt-3">
      <button nz-button (click)="refreshList()">Làm mới</button>
      <button nz-button nzType="primary" (click)="onSearch()">Tìm kiếm</button>
    </div>
  </div>
</nz-dropdown-menu>

<app-scroll-table [height]="'480px'">
  <nz-table [nzData]="subjects" nzBordered [nzLoading]="loading" [nzFrontPagination]="false" [nzNoResult]="emptyTpl"
    (nzCurrentPageDataChange)="onCurrentPageDataChange($event)">
  <thead>
    <tr>
      <th [nzChecked]="checked" [nzIndeterminate]="indeterminate" (nzCheckedChange)="onAllChecked($event)"
        nzWidth="48px"></th>
      <th style="width:56px; text-align:center; font-weight:bold">STT</th>
      <th style="width:64px; text-align:center">Thao tác</th>
      <th style="font-weight:bold; cursor:pointer;" (click)="changeSort('MaMonHoc')">Mã môn học
        <i nz-icon [nzType]="sortBy === 'MaMonHoc' ? (sortDir === 'ASC' ? 'caret-up' : 'caret-down') : 'caret-up'" class="ml-1 text-sm"></i>
      </th>
      <th style="font-weight:bold; cursor:pointer;" (click)="changeSort('TenMonHoc')">Tên môn học
        <i nz-icon [nzType]="sortBy === 'TenMonHoc' ? (sortDir === 'ASC' ? 'caret-up' : 'caret-down') : 'caret-up'" class="ml-1 text-sm"></i>
      </th>
      <th style="font-weight:bold; cursor:pointer;" (click)="changeSort('SoTinChi')">Số tín chỉ
        <i nz-icon [nzType]="sortBy === 'SoTinChi' ? (sortDir === 'ASC' ? 'caret-up' : 'caret-down') : 'caret-up'" class="ml-1 text-sm"></i>
      </th>
      <th style="font-weight:bold; cursor:pointer;" (click)="changeSort('SoTiet')">Số tiết
        <i nz-icon [nzType]="sortBy === 'SoTiet' ? (sortDir === 'ASC' ? 'caret-up' : 'caret-down') : 'caret-up'" class="ml-1 text-sm"></i>
      </th>
      <th style="font-weight:bold; cursor:pointer;" (click)="changeSort('LoaiMon')">Loại môn
        <i nz-icon [nzType]="sortBy === 'LoaiMon' ? (sortDir === 'ASC' ? 'caret-up' : 'caret-down') : 'caret-up'" class="ml-1 text-sm"></i>
      </th>
      <th style="font-weight:bold; cursor:pointer;" (click)="changeSort('MoTa')">Mô tả
        <i nz-icon [nzType]="sortBy === 'MoTa' ? (sortDir === 'ASC' ? 'caret-up' : 'caret-down') : 'caret-up'" class="ml-1 text-sm"></i>
      </th>
      <th>Trạng thái</th>
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let s of subjects; index as i">
      <td [nzChecked]="setOfCheckedId.has(getRowKey(s))" (nzCheckedChange)="onItemChecked(getRowKey(s), $event)"
        nzWidth="48px"></td>
      <td class="text-center">{{ (page - 1) * pageSize + (i + 1) }}</td>
      <td class="text-center">
        <a nz-dropdown [nzDropdownMenu]="menu" nzTrigger="hover">
          <span nz-icon nzType="bars" nzTheme="outline"></span>
        </a>
        <nz-dropdown-menu #menu="nzDropdownMenu">
          <ul nz-menu nzSelectable>
            <li nz-menu-item (click)="openEdit(s)">
              <i nz-icon nzType="edit" class="mr-2"></i>
              Chỉnh sửa
            </li>
            <li nz-menu-item (click)="confirmDeactivate(s)">
              <i nz-icon nzType="stop" class="mr-2" style="color:#cf1322"></i>
              Vô hiệu hóa
            </li>
            <li nz-menu-item (click)="navigateToCourses(s)">
              <i nz-icon nzType="team" class="mr-2"></i>
              Lớp học phần của môn
            </li>
          </ul>
        </nz-dropdown-menu>
      </td>
      <td>{{ s.maMonHoc }}</td>
      <td>{{ s.tenMonHoc }}</td>
      <td>{{ s.soTinChi }}</td>
      <td>{{ s.soTiet }}</td>
      <td>{{ getLoaiLabel(s.loaiMon) }}</td>
      <td>{{ s.moTa }}</td>
      <td class="text-center">
        <app-status-pill [state]="s.trangThai"></app-status-pill>
      </td>
    </tr>
  </tbody>
  </nz-table>
</app-scroll-table>

<!-- Empty state tiếng Việt -->
<ng-template #emptyTpl>
  <app-table-empty></app-table-empty>
</ng-template>

<div class="mt-3 flex justify-end" *ngIf="subjects.length > 0 && total > pageSize">
  <nz-pagination [nzPageIndex]="page" [nzPageSize]="pageSize" [nzTotal]="total"
    (nzPageIndexChange)="onPageChange($event)">
  </nz-pagination>
</div>

<nz-modal [(nzVisible)]="isCreateVisible" nzTitle="Thêm môn học" (nzOnCancel)="isCreateVisible=false"
  (nzOnOk)="create()" [nzOkLoading]="creating" nzOkText="Lưu" nzCancelText="Hủy">
  <ng-container *nzModalContent>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
      <div><label>Tên môn học</label><input nz-input [(ngModel)]="newSubject.TenMonHoc" /></div>
      <div><label>Số tín chỉ</label><input nz-input type="number" [(ngModel)]="newSubject.SoTinChi" /></div>
      <div><label>Số tiết</label><input nz-input type="number" [(ngModel)]="newSubject.SoTiet" /></div>
      <div><label>Loại môn</label>
        <nz-select [(ngModel)]="newSubject.LoaiMon">
          <nz-option [nzLabel]="'Lý thuyết'" [nzValue]="1"></nz-option>
          <nz-option [nzLabel]="'Thực hành'" [nzValue]="2"></nz-option>
          <nz-option [nzLabel]="'Lý thuyết & Thực hành'" [nzValue]="3"></nz-option>
        </nz-select>
      </div>
      <div class="md:col-span-2"><label>Mô tả</label><input nz-input [(ngModel)]="newSubject.MoTa" /></div>
      <div><label>Trạng thái</label>
        <nz-select [(ngModel)]="newSubject.TrangThai">
          <nz-option [nzLabel]="'Hoạt động'" [nzValue]="true"></nz-option>
          <nz-option [nzLabel]="'Ngừng hoạt động'" [nzValue]="false"></nz-option>
        </nz-select>
      </div>
    </div>
  </ng-container>
</nz-modal>

<nz-modal [(nzVisible)]="isEditVisible" nzTitle="Sửa môn học" (nzOnCancel)="isEditVisible=false" (nzOnOk)="update()"
  [nzOkLoading]="updating" nzOkText="Lưu" nzCancelText="Hủy">
  <ng-container *nzModalContent>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
      <div><label>Mã môn học</label><input nz-input [(ngModel)]="selectedSubject.MaMonHoc" disabled /></div>
      <div><label>Tên môn học</label><input nz-input [(ngModel)]="selectedSubject.TenMonHoc" /></div>
      <div><label>Số tín chỉ</label><input nz-input type="number" [(ngModel)]="selectedSubject.SoTinChi" /></div>
      <div><label>Số tiết</label><input nz-input type="number" [(ngModel)]="selectedSubject.SoTiet" /></div>
      <div><label>Loại môn</label>
        <nz-select [(ngModel)]="selectedSubject.LoaiMon">
          <nz-option [nzLabel]="'Lý thuyết'" [nzValue]="1"></nz-option>
          <nz-option [nzLabel]="'Thực hành'" [nzValue]="2"></nz-option>
          <nz-option [nzLabel]="'Lý thuyết & Thực hành'" [nzValue]="3"></nz-option>
        </nz-select>
      </div>
      <div class="md:col-span-2"><label>Mô tả</label><input nz-input [(ngModel)]="selectedSubject.MoTa" /></div>
      <div><label>Trạng thái</label>
        <nz-select [(ngModel)]="selectedSubject.TrangThai">
          <nz-option [nzLabel]="'Hoạt động'" [nzValue]="true"></nz-option>
          <nz-option [nzLabel]="'Ngừng hoạt động'" [nzValue]="false"></nz-option>
        </nz-select>
      </div>
    </div>
  </ng-container>
</nz-modal>
