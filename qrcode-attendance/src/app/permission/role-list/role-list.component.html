<div class="p-4 bg-white rounded shadow">
  <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-4">
    <div class="flex flex-wrap items-center gap-2">
      <input nz-input placeholder="Nhập để tìm kiếm" [(ngModel)]="keyword" [ngModelOptions]="{standalone: true}"
        (keyup.enter)="onSearch()" class="border rounded px-2 py-1 w-64" />
      <button nz-button nzType="primary" (click)="onSearch()"
        class="border rounded px-3 py-1 font-semibold flex items-center">
        <i nz-icon nzType="search" class="mr-1"></i>
        <span>Tìm kiếm</span>
      </button>
      <button nz-button (click)="refreshList()" class="border rounded px-3 py-1 font-semibold flex items-center ml-2">
        <i nz-icon nzType="reload" class="mr-1"></i>
        <span>Làm mới</span>
      </button>
    </div>

    <div class="mt-2 sm:mt-0">
      <button nz-button nzType="primary" (click)="showCreate()"
        class="flex items-center px-4 py-2 rounded shadow-md text-white">
        <i nz-icon nzType="plus" nzTheme="outline" class="mr-2 text-white"></i>
        <span class="font-semibold">Thêm phân quyền</span>
      </button>
    </div>
  </div>

  <app-scroll-table [height]="'450px'">
    <nz-table #basicTable [nzData]="list" [nzLoading]="loading" nzBordered [nzFrontPagination]="false"
      [nzNoResult]="emptyTpl">
      <thead>
        <tr>
          <th>STT</th>
          <th>Mã quyền</th>
          <th>Tên quyền</th>
          <th>Mô tả</th>
          <th>Trạng thái</th>
          <th>Hành động</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let r of basicTable.data; let i = index">
          <td>{{ (pageIndex-1)*pageSize + i + 1 }}</td>
          <td>{{ r.CodeQuyen || r.codeQuyen }}</td>
          <td>{{ r.TenQuyen || r.tenQuyen }}</td>
          <td>{{ r.MoTa || r.moTa }}</td>
          <td class="text-center">
            <app-status-pill [state]="r.trangThai"></app-status-pill>
          </td>
          <td>
            <button nz-button nzType="link" nzSize="small" (click)="showEdit(r)"
              class="inline-flex items-center gap-1 text-gray-700 align-middle">
              <i nz-icon nzType="edit" nzTheme="outline" class="text-gray-600"
                style="display:inline-flex; align-items:center; vertical-align:middle;"></i>
              <span class="align-middle text-gray-700">Sửa</span>
            </button>
            <button nz-button nzType="link" nzSize="small" (click)="confirmDelete(r)"
              class="inline-flex items-center gap-1 ml-2 text-gray-700 align-middle">
              <i nz-icon nzType="delete" nzTheme="outline" class="text-gray-600"
                style="display:inline-flex; align-items:center; vertical-align:middle;"></i>
              <span class="align-middle text-gray-700">Xóa</span>
            </button>
            <button nz-button nzType="link" nzSize="small" (click)="openGroupsForRole(r)"
              class="inline-flex items-center gap-1 ml-2 text-gray-700 align-middle">
              <i nz-icon nzType="appstore" nzTheme="outline" class="text-gray-600"
                style="display:inline-flex; align-items:center; vertical-align:middle;"></i>
              <span class="align-middle text-gray-700">Nhóm chức năng</span>
            </button>
          </td>
        </tr>
      </tbody>
    </nz-table>
  </app-scroll-table>

  <ng-template #emptyTpl>
    <app-table-empty></app-table-empty>
  </ng-template>

  <nz-pagination [nzTotal]="total" [nzPageSize]="pageSize" [(nzPageIndex)]="pageIndex"
    (nzPageIndexChange)="onPageChange($event)" [nzShowSizeChanger]="false"
    class="mt-3 flex justify-end"></nz-pagination>

  <nz-modal [(nzVisible)]="editVisible" nzTitle="Thêm Phân quyền" (nzOnCancel)="editVisible=false" [nzOkText]="'Lưu'"
    [nzCancelText]="'Hủy'" (nzOnOk)="save()" (nzOnCancel)="editVisible=false">
    <ng-container *nzModalContent>
      <form [formGroup]="editForm">
        <label>Code quyền</label>
        <input nz-input formControlName="CodeQuyen" />
        <label>Tên quyền</label>
        <input nz-input formControlName="TenQuyen" />
        <label>Mô tả</label>
        <textarea nz-input formControlName="MoTa"></textarea>
        <label>Trạng thái</label>
        <nz-select formControlName="TrangThai">
          <nz-option [nzValue]="true" nzLabel="Hoạt động"></nz-option>
          <nz-option [nzValue]="false" nzLabel="Ngừng hoạt động"></nz-option>
        </nz-select>
      </form>
    </ng-container>
  </nz-modal>

  <nz-modal [(nzVisible)]="isGroupsVisible" nzTitle="Danh sách nhóm chức năng" [nzOkText]="'Lưu'" [nzCancelText]="'Hủy'"
    (nzOnOk)="applyGroupChanges()" (nzOnCancel)="cancelGroups()" [nzWidth]="800">
    <ng-container *nzModalContent>
      <div *ngIf="groupLoading">Đang tải...</div>
      <ul class="divide-y" style="max-height:480px; overflow:auto; padding:0">
        <ng-container *ngFor="let it of groupsFlat">
          <li *ngIf="it.level===1 || isParentExpanded(it.parentId)" class="p-2 flex items-center justify-between"
            [style.padding-left.px]="(it.level-1)*35">
            <div class="flex items-center">
              <span *ngIf="hasToggle(it)" (click)="toggleGroup(it.maChucNang); $event.stopPropagation()"
                style="cursor:pointer; width:20px; display:inline-flex; align-items:center; justify-content:center; margin-right:6px; font-weight:600">
                {{ isExpanded(it.maChucNang) ? '−' : '+' }}
              </span>
              <span *ngIf="it.level===1 && !hasToggle(it)"
                style="display:inline-block; width:20px; margin-right:6px"></span>
              <span *ngIf="it.level===1" class="font-semibold">{{ it.tenChucNang }}</span>
              <span *ngIf="it.level===2">{{ it.tenChucNang }}</span>
              <small class="text-gray-500" style="margin-left:6px"> ({{ it.codeChucNang }})</small>
            </div>
            <input type="checkbox" [checked]="it.trangThai" (change)="onToggleItem(it, $any($event.target).checked)"
              [disabled]="savingMap[it.maChucNang]" />
          </li>
        </ng-container>
      </ul>
    </ng-container>
  </nz-modal>
</div>