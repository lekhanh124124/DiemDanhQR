<div class="p-4">
  <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3 items-end">
    <div class="flex flex-col">
      <label class="mb-1 font-medium">Lớp học phần</label>
      <nz-select [(ngModel)]="selectedClass" style="width:100%" nzAllowClear nzPlaceHolder="Chọn lớp học phần">
        <nz-option *ngFor="let c of classSections" [nzValue]="c.maLopHocPhan" [nzLabel]="c.tenLopHocPhan"></nz-option>
      </nz-select>
    </div>

    <div class="flex items-center gap-2 flex-wrap">
      <button nz-button nzType="primary" (click)="load()"
        class="flex items-center justify-center border rounded px-3 py-1 font-semibold min-w-0 w-full sm:w-auto">
        <i nz-icon nzType="search" class="mr-2"></i>
        <span class="truncate">Tìm kiếm</span>
      </button>

      <button nz-button (click)="clearFilters()"
        class="flex items-center justify-center border rounded px-3 py-1 font-semibold min-w-0 w-full sm:w-auto">
        <i nz-icon nzType="reload" class="mr-2"></i>
        <span class="truncate">Làm mới</span>
      </button>
    </div>
  </div>

  <div class="history-summary mt-4">
    <div class="inline-block bg-white border rounded p-2 shadow-sm mb-4" style="min-width:200px; max-width:520px;">
      <div class="text-sm font-semibold">Tổng số buổi: <span class="font-bold ml-1">{{ totalSessions || 0 }}</span>
      </div>
      <div class="mt-2 text-sm">
        <span class="mr-3">Có mặt: <span class="text-green-600 font-semibold">{{ presentCount || 0 }}</span></span>
        <span class="mr-3">Vắng (không phép): <span class="text-red-600 font-semibold">{{ absentUnpermittedCount || 0
            }}</span></span>
        <span>Vắng (có phép): <span class="text-yellow-600 font-semibold">{{ absentPermittedCount || 0 }}</span></span>
      </div>
    </div>
  </div>
</div>

<app-scroll-table [height]="'520px'">
  <nz-table [nzData]="attendanceHistory" nzBordered [nzNoResult]="emptyTpl" [nzLoading]="loading">
    <thead>
      <tr>
        <th>STT</th>
        <th>Ngày học</th>
        <th>Môn học</th>
        <th>Trạng thái</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let record of attendanceHistory; let i = index">
        <td>{{ i + 1 }}</td>
        <td>{{ record.ngayHoc || record.ngay }}</td>
        <td>{{ record.tenMonHoc || record.monHoc }}</td>
        <td>
          <span [ngClass]="{
            'text-green-600': ['present', 'Có mặt', true].includes(record.trangThai),
            'text-yellow-600': record.trangThai === 'Trễ' || record.trangThai === 'late',
            'text-red-600': record.trangThai === 'absent' || (record.trangThai && record.trangThai.toString().includes('Vắng'))
          }">{{ record.trangThai }}</span>
        </td>
        <td></td>
      </tr>
    </tbody>
    <ng-template #emptyTpl>
      <app-table-empty></app-table-empty>
    </ng-template>
  </nz-table>
</app-scroll-table>
